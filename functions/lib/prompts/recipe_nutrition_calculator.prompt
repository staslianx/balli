model: vertexai/gemini-2.5-pro
config:
  temperature: 0.0
  topP: 1.0
  maxOutputTokens: 8192
input:
  schema:
    properties:
      recipeName:
        type: string
        description: "Name of the recipe"
      recipeContent:
        type: string
        description: "Full recipe content in markdown format with ingredients and directions"
      servings:
        type: number
        description: "Number of servings the recipe makes"
    required: [recipeName, recipeContent, servings]
output:
  format: json
  schema:
    type: object
    properties:
      calories:
        type: number
        description: "Calories per 100g"
      carbohydrates:
        type: number
        description: "Total carbs per 100g in grams"
      fiber:
        type: number
        description: "Fiber per 100g in grams"
      sugar:
        type: number
        description: "Sugar per 100g in grams"
      protein:
        type: number
        description: "Protein per 100g in grams"
      fat:
        type: number
        description: "Fat per 100g in grams"
      glycemicLoad:
        type: number
        description: "Estimated GL per portion (same as perPortion.glycemicLoad)"
      perPortion:
        type: object
        description: "Nutrition values for one portion"
        properties:
          weight:
            type: number
            description: "Weight of one portion in grams"
          calories:
            type: number
            description: "Calories per portion"
          carbohydrates:
            type: number
            description: "Carbs per portion in grams"
          fiber:
            type: number
            description: "Fiber per portion in grams"
          sugar:
            type: number
            description: "Sugar per portion in grams"
          protein:
            type: number
            description: "Protein per portion in grams"
          fat:
            type: number
            description: "Fat per portion in grams"
          glycemicLoad:
            type: number
            description: "GL per portion (same as top-level glycemicLoad)"
      nutritionCalculation:
        type: object
        description: "Detailed breakdown"
        properties:
          totalRecipeWeight:
            type: number
            description: "Total cooked weight in grams"
          totalRecipeCalories:
            type: number
            description: "Total calories"
          calculationNotes:
            type: string
            description: "Brief calculation explanation"
          reasoningSteps:
            type: array
            description: "Explicit reasoning for each ingredient transformation"
            items:
              type: object
              properties:
                ingredient:
                  type: string
                  description: "Ingredient name"
                recipeContext:
                  type: string
                  description: "What the recipe says about this ingredient"
                reasoning:
                  type: string
                  description: "Why this cooking loss/transformation was applied"
                calculation:
                  type: string
                  description: "Math shown explicitly"
                confidence:
                  type: string
                  enum: ["high", "medium", "low"]
                  description: "Confidence in this calculation"
          sanityCheckResults:
            type: object
            description: "Automated sanity checks"
            properties:
              erythritolCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING", "N/A"]
                  message:
                    type: string
              totalWeightCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING"]
                  message:
                    type: string
              calorieRangeCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING"]
                  message:
                    type: string
              macroBalanceCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING"]
                  message:
                    type: string
              crossValidationCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL"]
                  message:
                    type: string

**NOTE:** glycemicLoad at top-level and perPortion.glycemicLoad must be identical values (GL is a per-portion metric only)

---

# MEDICAL-GRADE NUTRITION CALCULATOR

Calculate nutrition with medical precision for diabetic patients using USDA FoodData Central.

---

## WORKFLOW

### 1. EXTRACT INGREDIENTS

From recipe markdown, extract for each ingredient:
- Name
- Weight (grams or ml)
- State (raw/dry/cooked)
- When added (step number from Yapılışı)
- How long it cooks after being added
- Cooking method (sotele/pişir/haşla/fırınla/ekle)
- Lid status if mentioned (kapalı/açık)

### 2. CALCULATE NUTRITION (Pre-cooking)

Use USDA values based on ingredient state:

<usda_values>

**PROTEINS (use cooked values for raw meat):**
- Chicken breast raw → Use cooked: 165 kcal, 31g protein, 3.6g fat per 100g
- Egg raw → Use cooked: 155 kcal, 13g protein, 10.6g fat per 100g
- Fish raw → Use cooked values

**GRAINS (use dry values for dry grains):**
- Quinoa dry: 368 kcal, 14.1g protein, 6.1g fat, 64.2g carbs, 7g fiber per 100g
- Bulgur dry: 342 kcal, 12.3g protein, 1.3g fat, 75.9g carbs, 12.5g fiber per 100g
- Rice dry: 365 kcal, 7.1g protein, 0.7g fat, 80g carbs per 100g
- Oats dry: 389 kcal, 16.9g protein, 6.9g fat, 66.3g carbs, 10.6g fiber per 100g
- Lentils dry: 352 kcal, 25.8g protein, 1.1g fat, 63.4g carbs, 10.7g fiber per 100g

**VEGETABLES (use raw values):**
- Spinach: 23 kcal, 2.9g protein, 0.4g fat, 3.6g carbs, 2.2g fiber per 100g
- Carrot: 41 kcal, 0.9g protein, 0.2g fat, 9.6g carbs, 2.8g fiber per 100g
- Tomato: 18 kcal, 0.9g protein, 0.2g fat, 3.9g carbs, 1.2g fiber per 100g
- Onion: 40 kcal, 1.1g protein, 0.1g fat, 9.3g carbs, 1.7g fiber per 100g
- Pepper: 31 kcal, 1g protein, 0.3g fat, 6g carbs, 2.1g fiber per 100g
- Zucchini: 17 kcal, 1.2g protein, 0.3g fat, 3.1g carbs, 1g fiber per 100g
- Mushroom: 22 kcal, 3.1g protein, 0.3g fat, 3.3g carbs, 1g fiber per 100g
- Garlic: 149 kcal, 6.4g protein, 0.5g fat, 33g carbs, 2.1g fiber per 100g

**FATS:**
- Olive oil: 884 kcal, 0g protein, 100g fat, 0g carbs per 100g
- Butter: 717 kcal, 0.9g protein, 81.1g fat, 0.1g carbs per 100g

**ERYTHRITOL (CRITICAL):**
- Calories: 24 kcal per 100g (0.24 kcal per gram)
- Carbohydrates: 0g (not absorbed by body)
- NEVER count erythritol as carbs

**OTHER SWEETENERS:**
- Stevia/Monk fruit/Sucralose: 0 kcal, 0g carbs
- Xylitol: 240 kcal per 100g, minimal carbs

**NUTS:**
- Peanuts: 567 kcal, 25.8g protein, 49.2g fat, 16.1g carbs, 8.5g fiber per 100g
- Almonds: 579 kcal, 21.2g protein, 49.9g fat, 21.6g carbs, 12.5g fiber per 100g
- Walnuts: 654 kcal, 15.2g protein, 65.2g fat, 13.7g carbs, 6.7g fiber per 100g

For ingredients not listed: Use standard USDA FoodData Central values.

</usda_values>

For each ingredient:
```
total_nutrition = weight_g × (usda_per_100g ÷ 100)
```

Sum all ingredients to get pre-cooking totals.

### 3. CALCULATE COOKED WEIGHT

<cooking_loss_formula>

**STEP 1: Identify ingredient category**

- Leafy greens: spinach (ıspanak), kale (karalahana), chard (pazı)
- Watery vegetables: tomato (domates), zucchini (kabak), eggplant (patlıcan), mushroom (mantar), pepper (biber)
- Root vegetables: carrot (havuç), potato (patates), beet (pancar)
- Aromatics: onion (soğan), garlic (sarımsak), leek (pırasa)
- Firm vegetables: broccoli (brokoli), cauliflower (karnabahar), green beans (fasulye)
- Proteins: chicken (tavuk), beef (et), fish (balık), egg (yumurta)
- Grains: quinoa (kinoa), bulgur, rice (pirinç), oats (yulaf), lentils (mercimek)
- Fats/oils: zeytinyağı, tereyağı (always 1.00 retention)

**STEP 2: Calculate base retention**

| Category | Base Retention |
|----------|---------------|
| Leafy greens | 0.70 |
| Watery vegetables | 0.80 |
| Root vegetables | 0.85 |
| Aromatics | 0.75 |
| Firm vegetables | 0.85 |
| Proteins | 0.75 |
| Fats/oils | 1.00 |

**STEP 3: Adjust for cooking time**

From recipe, calculate total minutes ingredient is exposed to heat.

| Time | Adjustment |
|------|-----------|
| 0 min (garnish/raw) | Set retention to 1.00 |
| < 3 min | +0.10 |
| 3-10 min | +0.00 |
| 10-20 min | -0.05 |
| > 20 min | -0.10 |

**STEP 4: Adjust for cooking method**

| Method | Adjustment |
|--------|-----------|
| Covered (kapağını kapat) | +0.05 |
| Uncovered (açık) | -0.05 |
| Boiling in water (haşla) | +0.10 |
| High heat (kızgın yağ) | -0.05 |

**STEP 5: Calculate final retention**

```
final_retention = base + time_adjustment + method_adjustment
Clamp between 0.50 and 1.00
```

**STEP 6: Apply to weight**

```
cooked_weight = raw_weight × final_retention
```

**SPECIAL CASE: DRY GRAINS**

If ingredient is dry grain (kuru ağırlık) that gets cooked:
1. Use dry USDA values for nutrition
2. Cooked weight = dry_weight × 3 (expansion, not loss)
3. Do NOT apply retention formula to grains

**SPECIAL CASE: GARNISH**

If recipe says "servis için" or "servis öncesi" or ingredient added in last step with "ekle":
- Retention = 1.00 (no cooking)

</cooking_loss_formula>

<liquid_handling>

**LIQUIDS (Water, Broth, Milk)**

Step 1: Check if dry grains present
- Grains absorb 2× their dry weight
- Example: 30g dry quinoa absorbs 60ml

Step 2: Calculate remaining liquid
- Total liquid - grain absorption = remaining

Step 3: Apply evaporation
- Covered cooking: 75% retention
- Uncovered cooking: 50% retention
- Added at end: 100% retention

Example:
```
300ml broth added
30g dry quinoa → absorbs 60ml
Remaining: 300 - 60 = 240ml
Covered 20 min: 240 × 0.75 = 180ml retained
```

Final liquid weight = retained ml (1ml = 1g for water-based)

</liquid_handling>

Total cooked weight = Σ(cooked ingredient weights) + retained liquid weight

### 4. CALCULATE PER 100G

```
per_100g = total_nutrition ÷ (cooked_weight ÷ 100)
```

### 5. CALCULATE PER PORTION

```
per_portion_weight = cooked_weight ÷ servings
per_portion_nutrition = total_nutrition ÷ servings
```

**Glycemic Load (IMPORTANT: Only per portion, NOT per 100g):**

```
net_carbs = carbs_per_portion - fiber_per_portion
GL = (net_carbs × estimated_GI) ÷ 100

Estimate GI based on primary carb source:
- Whole grains (quinoa, bulgur, oats): GI ≈ 50-55
- Refined grains (white rice, white bread): GI ≈ 70-85
- Legumes (lentils, chickpeas): GI ≈ 30-40
- Mixed dishes: Weight average based on ingredients
```

**CRITICAL: The top-level `glycemicLoad` field must equal `perPortion.glycemicLoad`**
- Glycemic Load is a per-serving metric, not per 100g
- Both fields in the output JSON must have the same value

### 6. CROSS-VALIDATE

For each macro (calories, protein, fat, carbs, fiber, sugar):
```
check = (per_portion_value ÷ per_portion_weight) × 100
If |check - per_100g_value| > 0.1: FAIL (arithmetic error)
```

### 7. SANITY CHECKS

**Erythritol:** If present, verify carbs contribution = 0g (CRITICAL)

**Weight:** Cooked should be 40-150% of raw (grains expand, others lose water)

**Calories:** Per 100g should be 20-800 kcal (outside = likely error)

**Macros:** Sum of protein + fat + carbs + fiber should be 3-50g per 100g

**Cross-validation:** Must pass for all macros

If any check fails with FAIL status, report error and stop.

---

## WORKED EXAMPLES

### Example 1: Spinach 2 Minutes (The Critical Case)

**Recipe:** "50g taze ıspanak, kapağı açık, 2 dakika pişir"

**Calculation:**
```
Category: Leafy greens → base = 0.70
Time: 2 min < 3 min → +0.10
Method: Uncovered (açık) → -0.05
Final retention: 0.70 + 0.10 - 0.05 = 0.75
Cooked weight: 50g × 0.75 = 37.5g
```

**NOT:** 50g × 0.25 = 12.5g (ignores brief cooking time)

---

### Example 2: Carrot 22 Minutes Covered

**Recipe:** "60g havuç, 2 dakika kavur, then kapağını kapat 20 dakika pişir"

**Calculation:**
```
Category: Root vegetables → base = 0.85
Time: 2+20 = 22 min > 20 min → -0.10
Method: Covered (kapağını kapat) → +0.05
Final retention: 0.85 - 0.10 + 0.05 = 0.80
Cooked weight: 60g × 0.80 = 48g
```

---

### Example 3: Dry Quinoa Expansion

**Recipe:** "30g kinoa (kuru ağırlık), kapağını kapat 20 dakika pişir"

**Calculation:**
```
Special case: Dry grain
Nutrition: 30g × (368 kcal/100g) = 110.4 kcal
Cooked weight: 30g × 3 = 90g (expansion, not loss)
```

---

### Example 4: Garnish Peanuts

**Recipe:** "15g kavrulmuş fındık (servis için)"

**Calculation:**
```
Special case: Garnish (servis için)
Retention: 1.00
Cooked weight: 15g × 1.00 = 15g
```

---

### Example 5: Chicken Two-Stage

**Recipe:** "80g tavuk, 5 dakika sotele, then 20 dakika simmer"

**Calculation:**
```
Category: Proteins → base = 0.75
Time: 5+20 = 25 min > 20 min → -0.10
Method: No specific adjustment → +0.00
Final retention: 0.75 - 0.10 = 0.65
Cooked weight: 80g × 0.65 = 52g
```

---

### Example 6: Erythritol

**Recipe:** "10g eritritol"

**Calculation:**
```
Nutrition: 10g × 0.24 kcal/g = 2.4 kcal
Carbs: 0g (NOT 10g - critical for diabetics)
Weight: 10g × 1.00 = 10g (dissolves, no loss)
```

---

## REASONING DOCUMENTATION

For each ingredient, include:

**ingredient:** Name from recipe
**recipeContext:** Exact Turkish text describing this ingredient
**reasoning:**
- Category identified
- Base retention
- Time adjustment (show calculation of total minutes)
- Method adjustment
- Final retention calculation
**calculation:** Show math: "50g × 0.75 = 37.5g"
**confidence:**
- high: Clear category, explicit time/method
- medium: Estimated time or method
- low: Ambiguous recipe instructions

---

## FINAL CHECKLIST

Before outputting JSON, verify:

1. **Erythritol:** If present, carbs = 0g ✓
2. **Grains:** Used dry USDA values, applied 3× expansion ✓
3. **Brief cooking:** < 3 min got +0.10 adjustment ✓
4. **Garnishes:** "servis için" got 1.00 retention ✓
5. **Cross-validation:** All macros pass check ✓
6. **Retention clamped:** All retention factors between 0.50-1.00 ✓
7. **Glycemic Load:** Top-level glycemicLoad = perPortion.glycemicLoad (same value in both fields) ✓

---

## INPUT

Recipe: {{recipeName}}
Servings: {{servings}}
Content:
{{recipeContent}}
