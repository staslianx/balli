model: vertexai/gemini-2.5-pro
config:
  temperature: 0.0
  topP: 1.0
  maxOutputTokens: 8192
input:
  schema:
    properties:
      recipeName:
        type: string
        description: "Name of the recipe"
      recipeContent:
        type: string
        description: "Full recipe content in markdown format with ingredients and directions"
      servings:
        type: number
        description: "Number of servings the recipe makes"
      recipeType:
        type: string
        enum: ["aiGenerated", "manual"]
        description: "Recipe type: 'manual' = user-entered recipe (return total only), 'aiGenerated' = AI-generated recipe (return per100g + perPortion)"
    required: [recipeName, recipeContent, servings, recipeType]
output:
  format: json
  schema:
    type: object
    properties:
      calories:
        type: number
        description: "Calories per 100g (AI-generated recipes only)"
      carbohydrates:
        type: number
        description: "Total carbs per 100g in grams (AI-generated recipes only)"
      fiber:
        type: number
        description: "Fiber per 100g in grams (AI-generated recipes only)"
      sugar:
        type: number
        description: "Sugar per 100g in grams (AI-generated recipes only)"
      protein:
        type: number
        description: "Protein per 100g in grams (AI-generated recipes only)"
      fat:
        type: number
        description: "Fat per 100g in grams (AI-generated recipes only)"
      glycemicLoad:
        type: number
        description: "For AI-generated: MUST equal perPortion.glycemicLoad. For manual: total GL (client will divide)"
      totalRecipe:
        type: object
        description: "Total recipe nutrition (manual recipes only - populate this instead of per100g/perPortion)"
        properties:
          weight:
            type: number
            description: "Total cooked weight in grams"
          calories:
            type: number
            description: "Total calories for entire recipe"
          carbohydrates:
            type: number
            description: "Total carbs in grams"
          fiber:
            type: number
            description: "Total fiber in grams"
          sugar:
            type: number
            description: "Total sugar in grams"
          protein:
            type: number
            description: "Total protein in grams"
          fat:
            type: number
            description: "Total fat in grams"
          glycemicLoad:
            type: number
            description: "Total glycemic load (client will divide by user-defined portions)"
      perPortion:
        type: object
        description: "Nutrition values for one portion (AI-generated recipes only)"
        properties:
          weight:
            type: number
            description: "Weight of one portion in grams"
          calories:
            type: number
            description: "Calories per portion"
          carbohydrates:
            type: number
            description: "Carbs per portion in grams"
          fiber:
            type: number
            description: "Fiber per portion in grams"
          sugar:
            type: number
            description: "Sugar per portion in grams"
          protein:
            type: number
            description: "Protein per portion in grams"
          fat:
            type: number
            description: "Fat per portion in grams"
          glycemicLoad:
            type: number
            description: "MUST equal top-level glycemicLoad (same value in both fields)"
            constraint: "value === parent.glycemicLoad"
      nutritionCalculation:
        type: object
        description: "Detailed breakdown"
        properties:
          totalRecipeWeight:
            type: number
            description: "Total cooked weight in grams"
          totalRecipeCalories:
            type: number
            description: "Total calories"
          calculationNotes:
            type: string
            description: "Brief calculation explanation"
          reasoningSteps:
            type: array
            description: "Explicit reasoning for each ingredient transformation"
            items:
              type: object
              properties:
                ingredient:
                  type: string
                  description: "Ingredient name"
                recipeContext:
                  type: string
                  description: "What the recipe says about this ingredient"
                reasoning:
                  type: string
                  description: "Why this cooking loss/transformation was applied"
                calculation:
                  type: string
                  description: "Math shown explicitly"
                confidence:
                  type: string
                  enum: ["high", "medium", "low"]
                  description: "Confidence in this calculation"
          sanityCheckResults:
            type: object
            description: "Automated sanity checks"
            properties:
              erythritolCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING", "N/A"]
                  message:
                    type: string
              totalWeightCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING"]
                  message:
                    type: string
              calorieRangeCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING"]
                  message:
                    type: string
              macroBalanceCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING"]
                  message:
                    type: string
              crossValidationCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL"]
                  message:
                    type: string
              fiberAnomalyCheck:
                type: object
                properties:
                  status:
                    type: string
                    enum: ["PASS", "FAIL", "WARNING"]
                  message:
                    type: string
    required: [calories, carbohydrates, fiber, sugar, protein, fat, glycemicLoad]

---

# MEDICAL-GRADE NUTRITION CALCULATOR

Target precision:
- Calories: ±5 kcal per 100g
- Macros: ±0.5g per 100g
- Fiber: ±0.3g per 100g
- GL: ±1 unit per portion

Calculate nutrition with this precision for diabetic patients using USDA FoodData Central.

---

## INPUT HANDLING - RECIPE TYPE

**Check the `recipeType` input field to determine output format:**

### IF recipeType = "manual":
**MANUAL RECIPE FLOW** (User-entered recipe, no pre-defined portions)

1. Calculate ONLY the `totalRecipe` object with total values:
   - totalRecipe.weight = total cooked weight in grams
   - totalRecipe.calories = total calories for entire recipe
   - totalRecipe.carbohydrates = total carbs in grams
   - totalRecipe.fiber = total fiber in grams
   - totalRecipe.sugar = total sugar in grams
   - totalRecipe.protein = total protein in grams
   - totalRecipe.fat = total fat in grams
   - totalRecipe.glycemicLoad = total GL for entire recipe

2. **DO NOT** calculate per 100g values (client will calculate)
3. **DO NOT** calculate perPortion (user will define portion size later)
4. Set top-level `glycemicLoad` = totalRecipe.glycemicLoad (same value)
5. Include full `nutritionCalculation` with reasoningSteps and sanityCheckResults

**Example Manual Recipe Output:**
```json
{
  "glycemicLoad": 37,
  "totalRecipe": {
    "weight": 756,
    "calories": 1041,
    "carbohydrates": 77.6,
    "fiber": 11.2,
    "sugar": 11.9,
    "protein": 107.9,
    "fat": 32.5,
    "glycemicLoad": 37
  },
  "nutritionCalculation": { ...full breakdown... }
}
```

### IF recipeType = "aiGenerated":
**AI-GENERATED RECIPE FLOW** (Existing behavior, no changes)

1. Calculate per 100g values (calories, carbohydrates, fiber, sugar, protein, fat)
2. Calculate perPortion object based on servings:
   - perPortion.weight = totalRecipeWeight / servings
   - perPortion.calories = totalRecipeCalories / servings
   - perPortion.glycemicLoad = totalGL / servings
3. Set top-level glycemicLoad = perPortion.glycemicLoad
4. **DO NOT** populate totalRecipe object
5. Include full nutritionCalculation with reasoningSteps and sanityCheckResults

**Example AI-Generated Output:**
```json
{
  "calories": 137.7,
  "carbohydrates": 13.2,
  "fiber": 3.5,
  "sugar": 1.8,
  "protein": 14.3,
  "fat": 4.3,
  "glycemicLoad": 18,
  "perPortion": {
    "weight": 342,
    "calories": 480,
    "carbohydrates": 70.4,
    "fiber": 12.1,
    "sugar": 5.4,
    "protein": 20.9,
    "fat": 15.2,
    "glycemicLoad": 18
  },
  "nutritionCalculation": { ...full breakdown... }
}
```

---

## WORKFLOW

### 1. EXTRACT INGREDIENTS

From recipe markdown, extract for each ingredient:
- Name
- Weight (grams or ml)
- State (raw/dry/cooked)
- When added (step number from Yapılışı)
- How long it cooks after being added
- Cooking method (sotele/pişir/haşla/fırınla/ekle)
- Lid status if mentioned (kapalı/açık)

### 2. CALCULATE NUTRITION (Pre-cooking)

Use USDA values based on ingredient state:

<usda_values>

**PROTEINS - RAW MEAT VALUES:**

DEFAULT ASSUMPTION: All meat/poultry/fish in recipes is RAW unless explicitly stated otherwise.

Indicators meat is raw:
- No cooking descriptor: "150g tavuk", "200g dana biftek", "100g somon"
- Recipe shows cooking steps for this meat

Indicators meat is pre-cooked (rare):
- Explicit: "haşlanmış tavuk", "pişmiş et", "haşlanmış yumurta"

**Use these values for RAW meat (default):**
- Beef raw (dana): 250 kcal, 26g protein, 17g fat, 0g carbs per 100g
- Chicken breast raw (tavuk göğsü): 120 kcal, 22.5g protein, 2.6g fat, 0g carbs per 100g
- Chicken thigh raw (tavuk but): 211 kcal, 17.3g protein, 15.5g fat, 0g carbs per 100g
- Pork raw (domuz): 242 kcal, 21g protein, 17g fat, 0g carbs per 100g
- Lamb raw (kuzu): 294 kcal, 24.5g protein, 21.1g fat, 0g carbs per 100g
- Salmon raw (somon): 208 kcal, 20g protein, 13g fat, 0g carbs per 100g
- Shrimp raw (karides): 85 kcal, 18g protein, 1g fat, 1g carbs per 100g
- Egg raw whole (yumurta): 143 kcal, 12.6g protein, 9.5g fat, 0.7g carbs per 100g

**CRITICAL CALCULATION RULE:**
1. Calculate total protein: raw_weight_g × (protein_per_100g / 100)
2. Apply cooking loss to weight only: cooked_weight = raw_weight × retention
3. Total protein unchanged: protein molecules don't evaporate
4. Example: 150g raw beef → 31.5g total protein → cooks to 105g → still 31.5g total protein

**GRAINS (use dry values for dry grains):**
- Quinoa dry: 368 kcal, 14.1g protein, 6.1g fat, 64.2g carbs, 7g fiber per 100g
- Bulgur dry: 342 kcal, 12.3g protein, 1.3g fat, 75.9g carbs, 12.5g fiber per 100g
- Rice dry: 365 kcal, 7.1g protein, 0.7g fat, 80g carbs per 100g
- Oats dry: 389 kcal, 16.9g protein, 6.9g fat, 66.3g carbs, 10.6g fiber per 100g
- Lentils dry: 352 kcal, 25.8g protein, 1.1g fat, 63.4g carbs, 10.7g fiber per 100g

**VEGETABLES (use raw values):**
- Spinach: 23 kcal, 2.9g protein, 0.4g fat, 3.6g carbs, 2.2g fiber per 100g
- Carrot: 41 kcal, 0.9g protein, 0.2g fat, 9.6g carbs, 2.8g fiber per 100g
- Tomato: 18 kcal, 0.9g protein, 0.2g fat, 3.9g carbs, 1.2g fiber per 100g
- Onion: 40 kcal, 1.1g protein, 0.1g fat, 9.3g carbs, 1.7g fiber per 100g
- Pepper: 31 kcal, 1g protein, 0.3g fat, 6g carbs, 2.1g fiber per 100g
- Zucchini: 17 kcal, 1.2g protein, 0.3g fat, 3.1g carbs, 1g fiber per 100g
- Mushroom: 22 kcal, 3.1g protein, 0.3g fat, 3.3g carbs, 1g fiber per 100g
- Garlic: 149 kcal, 6.4g protein, 0.5g fat, 33g carbs, 2.1g fiber per 100g

**FATS:**
- Olive oil: 884 kcal, 0g protein, 100g fat, 0g carbs per 100g
- Butter: 717 kcal, 0.9g protein, 81.1g fat, 0.1g carbs per 100g

**ERYTHRITOL (CRITICAL):**
- Calories: 24 kcal per 100g (0.24 kcal per gram)
- Carbohydrates: 0g (not absorbed by body)
- NEVER count erythritol as carbs

**OTHER SWEETENERS:**
- Stevia/Monk fruit/Sucralose: 0 kcal, 0g carbs
- Xylitol: 240 kcal per 100g, minimal carbs

**NUTS:**
- Peanuts: 567 kcal, 25.8g protein, 49.2g fat, 16.1g carbs, 8.5g fiber per 100g
- Almonds: 579 kcal, 21.2g protein, 49.9g fat, 21.6g carbs, 12.5g fiber per 100g
- Walnuts: 654 kcal, 15.2g protein, 65.2g fat, 13.7g carbs, 6.7g fiber per 100g

For ingredients not listed: Use standard USDA FoodData Central values.

</usda_values>

For each ingredient:
```
total_nutrition = weight_g × (usda_per_100g ÷ 100)
```

Sum all ingredients to get pre-cooking totals.

### 3. CALCULATE COOKED WEIGHT

<cooking_loss_formula>

**STEP 1: Identify ingredient category**

- Leafy greens: spinach (ıspanak), kale (karalahana), chard (pazı)
- Watery vegetables: tomato (domates), zucchini (kabak), eggplant (patlıcan), mushroom (mantar), pepper (biber)
- Root vegetables: carrot (havuç), potato (patates), beet (pancar)
- Aromatics: onion (soğan), garlic (sarımsak), leek (pırasa)
- Firm vegetables: broccoli (brokoli), cauliflower (karnabahar), green beans (fasulye)
- Proteins: chicken (tavuk), beef (et), fish (balık), egg (yumurta)
- Grains: quinoa (kinoa), bulgur, rice (pirinç), oats (yulaf), lentils (mercimek)
- Fats/oils: zeytinyağı, tereyağı (always 1.00 retention)

**STEP 2: Start with base retention (before time/method adjustments)**

| Category | Base Retention |
|----------|---------------|
| Leafy greens | 0.70 |
| Watery vegetables | 0.80 |
| Root vegetables | 0.85 |
| Aromatics | 0.75 |
| Firm vegetables | 0.85 |
| Proteins | 0.75 |
| Fats/oils | 1.00 |

**STEP 3: Adjust for cooking time**

From recipe, calculate total minutes ingredient is exposed to heat.

| Time | Adjustment |
|------|-----------|
| 0 min (garnish/raw) | Set retention to 1.00 |
| < 3 min | +0.10 |
| 3-10 min | +0.00 |
| 10-20 min | -0.05 |
| > 20 min | -0.10 |

**STEP 4: Adjust for cooking method**

| Method | Adjustment |
|--------|-----------|
| Covered (kapağını kapat) | +0.05 |
| Uncovered (açık) | -0.05 |
| Boiling in water (haşla) | +0.10 |
| High heat (kızgın yağ) | -0.05 |

**STEP 5: Calculate final retention**

```
final_retention = base + time_adjustment + method_adjustment
Clamp between 0.50 and 1.00
```

**STEP 6: Apply to weight**

```
cooked_weight = raw_weight × final_retention
```

**SPECIAL CASE: DRY GRAINS**

If ingredient is dry grain (kuru ağırlık) that gets cooked:
1. Use dry USDA values for nutrition
2. Cooked weight = dry_weight × 3 (expansion, not loss)
3. Do NOT apply retention formula to grains

**SPECIAL CASE: GARNISH**

If recipe says "servis için" or "servis öncesi" or ingredient added in last step with "ekle":
- Retention = 1.00 (no cooking)

</cooking_loss_formula>

<liquid_handling>

**LIQUIDS (Water, Broth, Milk)**

Step 1: Check if dry grains present
- Grains absorb 2× their dry weight
- Example: 30g dry quinoa absorbs 60ml

Step 2: Calculate remaining liquid
- Total liquid - grain absorption = remaining

Step 3: Apply evaporation
- Covered cooking: 75% retention
- Uncovered cooking: 50% retention
- Added at end: 100% retention

Example:
```
300ml broth added
30g dry quinoa → absorbs 60ml
Remaining: 300 - 60 = 240ml
Covered 20 min: 240 × 0.75 = 180ml retained
```

Final liquid weight = retained ml (1ml = 1g for water-based)

</liquid_handling>

<fiber_handling>

**FIBER HANDLING (CRITICAL)**

Fiber is structural carbohydrate and does NOT cook out:

1. Calculate raw fiber: ingredient_weight × fiber_per_100g / 100
2. Fiber total stays constant through cooking
3. After cooking, fiber_per_100g increases due to water loss
4. Formula: cooked_fiber_per_100g = raw_fiber_total / (cooked_weight / 100)

Example:
- 50g spinach, 2.2g fiber/100g → 1.1g total fiber
- Cooks down to 37.5g
- Cooked density: 1.1g / (37.5g / 100) = 2.93g fiber/100g cooked weight

**CRITICAL: Never apply cooking retention to fiber content. Only ingredient weight changes.**

</fiber_handling>

Total cooked weight = Σ(cooked ingredient weights) + retained liquid weight

### 4. CALCULATE PER 100G

```
per_100g = total_nutrition ÷ (cooked_weight ÷ 100)
```

### 5. CALCULATE PER PORTION

```
per_portion_weight = cooked_weight ÷ servings
per_portion_nutrition = total_nutrition ÷ servings
```

**Glycemic Load - Nestlé Research Formula (IMPORTANT: Only per portion, NOT per 100g):**

Use this validated formula (Nestlé Research 2019, r=0.90 correlation) that accounts for protein/fat/fiber effects:

```
Step 1: Calculate Available Carbohydrates
availableCarbs = totalCarbs - fiber

Step 2: Split into Sugar vs Starch
sugarCarbs = min(sugar, availableCarbs)
starchCarbs = availableCarbs - sugarCarbs

Step 3: Calculate Glycemic Impact
// Sugar has lower GI (65) than starch (75)
glycemicImpact = (sugarCarbs × 0.65) + (starchCarbs × 0.75)

Step 4: Calculate GI-Lowering Effects
// These macros slow glucose absorption
fiberEffect = fiber × 0.3
proteinEffect = protein × 0.6
fatEffect = fat × 0.6

Step 5: Calculate Effective GI
denominator = availableCarbs + fiberEffect + proteinEffect + fatEffect
effectiveGI = (glycemicImpact × 100) ÷ denominator

Step 6: Final GL (Impact Score)
GL = (effectiveGI × availableCarbs) ÷ 100
```

**CRITICAL: The top-level `glycemicLoad` field must equal `perPortion.glycemicLoad`**
- Glycemic Load is a per-serving metric, not per 100g
- Both fields in the output JSON must have the same value
- All values used in calculation must be per-portion amounts (not per 100g)

### 6. CROSS-VALIDATE

Cross-validate against raw totals (source of truth):

```
For each macro (calories, protein, fat, carbs, fiber, sugar):
1. Sum per_portion values across all servings
2. Must equal total_nutrition (within ±1% for rounding)
3. Check: (per_portion_value × servings) ≈ total_nutrition_value

If |difference| > 1%: FAIL (arithmetic error)
```

### 7. SANITY CHECKS

Run these checks BEFORE outputting JSON:

**Erythritol:** If present, verify carbs contribution = 0g (CRITICAL)

**Weight:** Cooked should be 40-150% of raw (grains expand, others lose water)

**Calories:** Per 100g should be 20-800 kcal (outside = likely error)

**Macros:** Sum of protein + fat + carbs + fiber should be 3-50g per 100g

**Fiber Anomaly:**
- If fiber >15g per 100g → FAIL
- If fiber >40% of carbs → FAIL
- Expected range for most dishes: 1-8g fiber per 100g

**Cross-validation:** Must pass for all macros

**If any check fails with FAIL status:**
1. DO NOT output the JSON yet
2. Identify the specific calculation error
3. Recalculate the affected values
4. Re-run all sanity checks
5. Only then output JSON

### 8. SELF-CORRECTION PROTOCOL

After calculating all values, check for anomalies:

**Fiber anomaly check:**
- If fiber >15g per 100g → Likely error
- If fiber >40% of carbs → Likely error
- Recovery: Recalculate fiber using raw totals, not cooked density

**Weight anomaly check:**
- If cooked_weight >200% of raw_weight (except grains) → Likely error
- If cooked_weight <40% of raw_weight → Likely error
- Recovery: Review retention calculations, show work

**If you detect an anomaly:**
1. State in reasoningSteps: "Detected anomaly in [X]"
2. Show: Expected range vs. calculated value
3. Recheck: Show step-by-step recalculation
4. Correct: Output corrected values with explanation

---

## WORKED EXAMPLES

### Example 1: Spinach 2 Minutes (The Critical Case)

**Recipe:** "50g taze ıspanak, kapağı açık, 2 dakika pişir"

**Calculation:**
```
Category: Leafy greens → base = 0.70
Time: 2 min < 3 min → +0.10
Method: Uncovered (açık) → -0.05
Final retention: 0.70 + 0.10 - 0.05 = 0.75
Cooked weight: 50g × 0.75 = 37.5g
```

**NOT:** 50g × 0.25 = 12.5g (ignores brief cooking time)

---

### Example 2: Carrot 22 Minutes Covered

**Recipe:** "60g havuç, 2 dakika kavur, then kapağını kapat 20 dakika pişir"

**Calculation:**
```
Category: Root vegetables → base = 0.85
Time: 2+20 = 22 min > 20 min → -0.10
Method: Covered (kapağını kapat) → +0.05
Final retention: 0.85 - 0.10 + 0.05 = 0.80
Cooked weight: 60g × 0.80 = 48g
```

---

### Example 3: Dry Quinoa Expansion

**Recipe:** "30g kinoa (kuru ağırlık), kapağını kapat 20 dakika pişir"

**Calculation:**
```
Special case: Dry grain
Nutrition: 30g × (368 kcal/100g) = 110.4 kcal
Cooked weight: 30g × 3 = 90g (expansion, not loss)
```

---

### Example 4: Garnish Peanuts

**Recipe:** "15g kavrulmuş fındık (servis için)"

**Calculation:**
```
Special case: Garnish (servis için)
Retention: 1.00
Cooked weight: 15g × 1.00 = 15g
```

---

### Example 5: Chicken Two-Stage

**Recipe:** "80g tavuk, 5 dakika sotele, then 20 dakika simmer"

**Calculation:**
```
Category: Proteins → base = 0.75
Time: 5+20 = 25 min > 20 min → -0.10
Method: No specific adjustment → +0.00
Final retention: 0.75 - 0.10 = 0.65
Cooked weight: 80g × 0.65 = 52g
```

---

### Example 6: Erythritol

**Recipe:** "10g eritritol"

**Calculation:**
```
Nutrition: 10g × 0.24 kcal/g = 2.4 kcal
Carbs: 0g (NOT 10g - critical for diabetics)
Weight: 10g × 1.00 = 10g (dissolves, no loss)
```

---

### Example 7: Raw Beef Protein Calculation (CRITICAL)

**Recipe:** "150g dana biftek, sotele"

**CORRECT Calculation:**
```
Step 1: Calculate total protein from RAW values
150g raw beef × 26g protein/100g = 39g total protein

Step 2: Apply cooking loss to WEIGHT only
150g raw × 0.70 retention = 105g cooked

Step 3: Total protein UNCHANGED
Still 39g total protein (protein doesn't evaporate)

Step 4: Per 100g concentration increases
39g protein / 1.05 = 37.1g protein per 100g cooked beef
```

**WRONG Calculation (DO NOT DO THIS):**
```
✗ Using cooked protein values (31g/100g) for raw weight
✗ 150g × 31g/100g = 46.5g protein (INFLATED)
```

---

### Example 8: Glycemic Load Calculation Using Nestlé Formula

**Recipe per portion:** 
- Total carbs: 48g
- Fiber: 9g
- Sugar: 8g
- Protein: 40g
- Fat: 15g

**Step-by-step calculation:**
```
Step 1: Available Carbs
availableCarbs = 48 - 9 = 39g

Step 2: Split Sugar vs Starch
sugarCarbs = min(8, 39) = 8g
starchCarbs = 39 - 8 = 31g

Step 3: Glycemic Impact
glycemicImpact = (8 × 0.65) + (31 × 0.75)
glycemicImpact = 5.2 + 23.25 = 28.45

Step 4: GI-Lowering Effects
fiberEffect = 9 × 0.3 = 2.7
proteinEffect = 40 × 0.6 = 24.0
fatEffect = 15 × 0.6 = 9.0

Step 5: Effective GI
denominator = 39 + 2.7 + 24.0 + 9.0 = 74.7
effectiveGI = (28.45 × 100) ÷ 74.7 = 38.1

Step 6: Final GL
GL = (38.1 × 39) ÷ 100 = 14.9
Round to nearest integer: GL = 15
```

**Why this is better than simple formula:**
- Simple formula would give: GL = (39 × 55) / 100 = 21
- Nestlé formula correctly accounts for 40g protein + 15g fat
- Result: 15 vs 21 (29% lower, more accurate for mixed meal)

---

## REASONING DOCUMENTATION

For each ingredient, include:

**ingredient:** Name from recipe
**recipeContext:** Exact Turkish text describing this ingredient
**reasoning:**
- Category identified
- Base retention
- Time adjustment (show calculation of total minutes)
- Method adjustment
- Final retention calculation
**calculation:** Show math: "50g × 0.75 = 37.5g"
**confidence:**
- high: Clear category, explicit time/method
- medium: Estimated time or method
- low: Ambiguous recipe instructions

**For GL calculation, add a final reasoning step:**
**ingredient:** "Glycemic Load Calculation"
**recipeContext:** "Per-portion values used"
**reasoning:** Show all 6 steps of Nestlé formula with intermediate values
**calculation:** 
```
Step 1: availableCarbs = X - Y = Z
Step 2: sugarCarbs = A, starchCarbs = B
Step 3: glycemicImpact = (A × 0.65) + (B × 0.75) = C
Step 4: fiberEffect = D, proteinEffect = E, fatEffect = F
Step 5: effectiveGI = (C × 100) / (Z + D + E + F) = G
Step 6: GL = (G × Z) / 100 = H
```
**confidence:** high

---

## FINAL CHECKLIST

Before outputting JSON, verify:

1. **Erythritol:** If present, carbs = 0g ✓
2. **Grains:** Used dry USDA values, applied 3× expansion ✓
3. **Brief cooking:** < 3 min got +0.10 adjustment ✓
4. **Garnishes:** "servis için" got 1.00 retention ✓
5. **Fiber:** Calculated from raw totals, not affected by cooking retention ✓
6. **Cross-validation:** All macros pass check against raw totals (within ±1%) ✓
7. **Retention clamped:** All retention factors between 0.50-1.00 ✓
8. **Glycemic Load:** Top-level glycemicLoad = perPortion.glycemicLoad (same value in both fields) ✓
9. **GL Formula:** Used Nestlé 6-step formula with protein/fat/fiber effects ✓
10. **Sanity checks:** All checks passed, no FAIL status ✓
11. **Self-correction:** If anomalies detected, recalculated and documented ✓
12. **RAW PROTEIN VALUES:** Used raw meat USDA values (NOT cooked) for nutrition calculation ✓

---

## INPUT

Recipe: {{recipeName}}
Servings: {{servings}}
Content:
{{recipeContent}}
